<!DOCTYPE html>
<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <title>Funny Image Rating Survey</title>
  <h1> Funny Image Rating Survey</h1>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    #image-container {
      text-align: center;
      margin-bottom: 20px;
    }

    #rating-container {
      text-align: center;
    }

    #rating-buttons {
      margin-top: 10px;
    }

    #welcome {
      text-align: center;
      /*add css tags for a welcome page*/
      margin: 20px;
      font-size: 2em;
      font-family: sans-serif;
    }
    
    .rating-button {
      margin: 3px;
      color: yellow;
      background-color: blue;
      border-radius: 5px;
      text-align: center;
      padding: 5px;
      font-size: 0.8em;
    }

    #start-button {
      margin-top: 20px;
      color: yellow;
      background-color: blue;
      border-radius: 10px;
      text-align: center;
      padding: 10px;
      font-size: 1.5em;
      font-family: Arial;
    }

    #start-demographic-info {
      text-align: center;
      margin: 5px;
    }

    #demogr-title {
      font-size: 1.8em;
      font-family: Arial;
      color: blue;
    }

    .prompt {
      text-align: center;
      margin: 10px;
      font-size: 1.6em;
      font-family: Arial;
      color: blue;
      font-style: bold;
    }

    .value {
      text-align: center;
      font-size: 1.2em;
      font-family: sans-serif;
      color: black;
      margin: 5px;
    }

    #demogr-submit {
      margin-top: 20px;
      color: yellow;
      background-color: blue;
      border-radius: 10px;
      text-align: center;
      padding: 10px;
      font-size: 1.5em;
      font-family: Arial;
    }

    #processing-message {
      text-align: center;
      margin: 10px;
      font-size: 1.2em;
      font-family: sans-serif;
      color: blue;
    }

    #end_survey_quick_click {
      text-align: center;
      margin: 10px;
      font-size: 1.2em;
      font-family: sans-serif;
      color: blue;
    }

    button:active {
      background-color: yellow;
      color: blue;
    }
  </style>
</head>
<body>
  <div id="welcome">
    <p> Welcome to the Funny Image Rating Survey! </p>
    <p> Please rate the funniness of the images below on a scale of 1 to 10. (1 being not funny and 10 being very funny)</p>
    <p> The time required to rate all the images is 9-10 minutes</p>
    <p> Only click on the rating buttons once, and wait till the next image loads(maximum 1 second), a message will show you when the next image is being processed.</p>
    <p> We have checks to check for random clicking or robot activity, in that case you might not complete the survey.</p>
    <p> Please do not refresh the page. You will lose progress and will have to start again. </p>
    <p> There are 100-110 images in this survey</p>
    <p> At the end of the survey, we will provide you a code, please store it and use it appropriately to get the reward.</p>
    <p> Click the button below to begin. </p>
    <button class="start-button" value="1" id="start-button"> Let's Start</button>
  </div>
  <div id="start-demographic-info" style="display: none;">
    <p id="demogr-title" class="demogr-title">Demograhic Information</p>
    <p id="error-missing-message" style="display: none; color: red; font-size: large;">Please fill out all the fields.</p>
    <div>
      <p id="demogr-age" class="prompt">Age: <input type="number" id="age" name="age" min="18" max="120" value="25" class="value"></p>
    </div>
    <div>
      <p id="demogr-gender" class="prompt">Gender</p>
      <select name="gender" class="value">
        <option value="male"> Male </option>
        <option value="female"> Female </option>
        <option value="non-binary"> Non-binary </option>
      </select>
    </div>
    <div>
      <p id="demogr-prolific" class="prompt">Prolific ID: </p>
      <input type = "text" name="prolific-id" class="value">
      </input>
    </div>
    <div>
      <p id="demogr-nationality" class="prompt"> Nationality </p>
      <select name="nationality" class="value">
        <option value="">-- select one --</option>
        <option value="afghan">Afghan</option>
        <option value="albanian">Albanian</option>
        <option value="algerian">Algerian</option>
        <option value="american">American</option>
        <option value="andorran">Andorran</option>
        <option value="angolan">Angolan</option>
        <option value="antiguans">Antiguans</option>
        <option value="argentinean">Argentinean</option>
        <option value="armenian">Armenian</option>
        <option value="australian">Australian</option>
        <option value="austrian">Austrian</option>
        <option value="azerbaijani">Azerbaijani</option>
        <option value="bahamian">Bahamian</option>
        <option value="bahraini">Bahraini</option>
        <option value="bangladeshi">Bangladeshi</option>
        <option value="barbadian">Barbadian</option>
        <option value="barbudans">Barbudans</option>
        <option value="batswana">Batswana</option>
        <option value="belarusian">Belarusian</option>
        <option value="belgian">Belgian</option>
        <option value="belizean">Belizean</option>
        <option value="beninese">Beninese</option>
        <option value="bhutanese">Bhutanese</option>
        <option value="bolivian">Bolivian</option>
        <option value="bosnian">Bosnian</option>
        <option value="brazilian">Brazilian</option>
        <option value="british">British</option>
        <option value="bruneian">Bruneian</option>
        <option value="bulgarian">Bulgarian</option>
        <option value="burkinabe">Burkinabe</option>
        <option value="burmese">Burmese</option>
        <option value="burundian">Burundian</option>
        <option value="cambodian">Cambodian</option>
        <option value="cameroonian">Cameroonian</option>
        <option value="canadian">Canadian</option>
        <option value="cape verdean">Cape Verdean</option>
        <option value="central african">Central African</option>
        <option value="chadian">Chadian</option>
        <option value="chilean">Chilean</option>
        <option value="chinese">Chinese</option>
        <option value="colombian">Colombian</option>
        <option value="comoran">Comoran</option>
        <option value="congolese">Congolese</option>
        <option value="costa rican">Costa Rican</option>
        <option value="croatian">Croatian</option>
        <option value="cuban">Cuban</option>
        <option value="cypriot">Cypriot</option>
        <option value="czech">Czech</option>
        <option value="danish">Danish</option>
        <option value="djibouti">Djibouti</option>
        <option value="dominican">Dominican</option>
        <option value="dutch">Dutch</option>
        <option value="east timorese">East Timorese</option>
        <option value="ecuadorean">Ecuadorean</option>
        <option value="egyptian">Egyptian</option>
        <option value="emirian">Emirian</option>
        <option value="equatorial guinean">Equatorial Guinean</option>
        <option value="eritrean">Eritrean</option>
        <option value="estonian">Estonian</option>
        <option value="ethiopian">Ethiopian</option>
        <option value="fijian">Fijian</option>
        <option value="filipino">Filipino</option>
        <option value="finnish">Finnish</option>
        <option value="french">French</option>
        <option value="gabonese">Gabonese</option>
        <option value="gambian">Gambian</option>
        <option value="georgian">Georgian</option>
        <option value="german">German</option>
        <option value="ghanaian">Ghanaian</option>
        <option value="greek">Greek</option>
        <option value="grenadian">Grenadian</option>
        <option value="guatemalan">Guatemalan</option>
        <option value="guinea-bissauan">Guinea-Bissauan</option>
        <option value="guinean">Guinean</option>
        <option value="guyanese">Guyanese</option>
        <option value="haitian">Haitian</option>
        <option value="herzegovinian">Herzegovinian</option>
        <option value="honduran">Honduran</option>
        <option value="hungarian">Hungarian</option>
        <option value="icelander">Icelander</option>
        <option value="indian">Indian</option>
        <option value="indonesian">Indonesian</option>
        <option value="iranian">Iranian</option>
        <option value="iraqi">Iraqi</option>
        <option value="irish">Irish</option>
        <option value="israeli">Israeli</option>
        <option value="italian">Italian</option>
        <option value="ivorian">Ivorian</option>
        <option value="jamaican">Jamaican</option>
        <option value="japanese">Japanese</option>
        <option value="jordanian">Jordanian</option>
        <option value="kazakhstani">Kazakhstani</option>
        <option value="kenyan">Kenyan</option>
        <option value="kittian and nevisian">Kittian and Nevisian</option>
        <option value="kuwaiti">Kuwaiti</option>
        <option value="kyrgyz">Kyrgyz</option>
        <option value="laotian">Laotian</option>
        <option value="latvian">Latvian</option>
        <option value="lebanese">Lebanese</option>
        <option value="liberian">Liberian</option>
        <option value="libyan">Libyan</option>
        <option value="liechtensteiner">Liechtensteiner</option>
        <option value="lithuanian">Lithuanian</option>
        <option value="luxembourger">Luxembourger</option>
        <option value="macedonian">Macedonian</option>
        <option value="malagasy">Malagasy</option>
        <option value="malawian">Malawian</option>
        <option value="malaysian">Malaysian</option>
        <option value="maldivan">Maldivan</option>
        <option value="malian">Malian</option>
        <option value="maltese">Maltese</option>
        <option value="marshallese">Marshallese</option>
        <option value="mauritanian">Mauritanian</option>
        <option value="mauritian">Mauritian</option>
        <option value="mexican">Mexican</option>
        <option value="micronesian">Micronesian</option>
        <option value="moldovan">Moldovan</option>
        <option value="monacan">Monacan</option>
        <option value="mongolian">Mongolian</option>
        <option value="moroccan">Moroccan</option>
        <option value="mosotho">Mosotho</option>
        <option value="motswana">Motswana</option>
        <option value="mozambican">Mozambican</option>
        <option value="namibian">Namibian</option>
        <option value="nauruan">Nauruan</option>
        <option value="nepalese">Nepalese</option>
        <option value="new zealander">New Zealander</option>
        <option value="ni-vanuatu">Ni-Vanuatu</option>
        <option value="nicaraguan">Nicaraguan</option>
        <option value="nigerien">Nigerien</option>
        <option value="north korean">North Korean</option>
        <option value="northern irish">Northern Irish</option>
        <option value="norwegian">Norwegian</option>
        <option value="omani">Omani</option>
        <option value="pakistani">Pakistani</option>
        <option value="palauan">Palauan</option>
        <option value="panamanian">Panamanian</option>
        <option value="papua new guinean">Papua New Guinean</option>
        <option value="paraguayan">Paraguayan</option>
        <option value="peruvian">Peruvian</option>
        <option value="polish">Polish</option>
        <option value="portuguese">Portuguese</option>
        <option value="qatari">Qatari</option>
        <option value="romanian">Romanian</option>
        <option value="russian">Russian</option>
        <option value="rwandan">Rwandan</option>
        <option value="saint lucian">Saint Lucian</option>
        <option value="salvadoran">Salvadoran</option>
        <option value="samoan">Samoan</option>
        <option value="san marinese">San Marinese</option>
        <option value="sao tomean">Sao Tomean</option>
        <option value="saudi">Saudi</option>
        <option value="scottish">Scottish</option>
        <option value="senegalese">Senegalese</option>
        <option value="serbian">Serbian</option>
        <option value="seychellois">Seychellois</option>
        <option value="sierra leonean">Sierra Leonean</option>
        <option value="singaporean">Singaporean</option>
        <option value="slovakian">Slovakian</option>
        <option value="slovenian">Slovenian</option>
        <option value="solomon islander">Solomon Islander</option>
        <option value="somali">Somali</option>
        <option value="south african">South African</option>
        <option value="south korean">South Korean</option>
        <option value="spanish">Spanish</option>
        <option value="sri lankan">Sri Lankan</option>
        <option value="sudanese">Sudanese</option>
        <option value="surinamer">Surinamer</option>
        <option value="swazi">Swazi</option>
        <option value="swedish">Swedish</option>
        <option value="swiss">Swiss</option>
        <option value="syrian">Syrian</option>
        <option value="taiwanese">Taiwanese</option>
        <option value="tajik">Tajik</option>
        <option value="tanzanian">Tanzanian</option>
        <option value="thai">Thai</option>
        <option value="togolese">Togolese</option>
        <option value="tongan">Tongan</option>
        <option value="trinidadian or tobagonian">Trinidadian or Tobagonian</option>
        <option value="tunisian">Tunisian</option>
        <option value="turkish">Turkish</option>
        <option value="tuvaluan">Tuvaluan</option>
        <option value="ugandan">Ugandan</option>
        <option value="ukrainian">Ukrainian</option>
        <option value="uruguayan">Uruguayan</option>
        <option value="uzbekistani">Uzbekistani</option>
        <option value="venezuelan">Venezuelan</option>
        <option value="vietnamese">Vietnamese</option>
        <option value="welsh">Welsh</option>
        <option value="yemenite">Yemenite</option>
        <option value="zambian">Zambian</option>
        <option value="zimbabwean">Zimbabwean</option>
      </select>
    </div>
    <div>
      <p name="demogr-education" class="prompt">Education Level (In-progress or latest completed)</p>
      <select name="education" class="value">
      <option value="high_school">High School</option>
      <option value="undergraduate">Undergraduate</option>
      <option value="postgraduate">Postgraduate</option>
      </select>
    </div>
    <button type="demogr-submit" value="1" id="demogr-submit"> Submit </button>
  </div>
  <div id="image-container" style="display: none;">
    <img id="image" src="" alt="Image" height="300">
  </div>

  <div id="processing-message" style="display: none;">
    <p>Processing...Please Wait and Do Not Click any Ratings Buttons</p>
  </div>

  <div id="rating-container" style="display: none;">
    <p>How funny is the image?</p>
    <div style="display: flex; flex-direction: row; text-align: center; justify-content: center;">
      <p style="width: 100px;">Not Funny</p>
      <div id="rating-buttons">
        <button class="rating-button" value="1">1</button>
        <button class="rating-button" value="2">2</button>
        <button class="rating-button" value="3">3</button>
        <button class="rating-button" value="4">4</button>
        <button class="rating-button" value="5">5</button>
        <button class="rating-button" value="6">6</button>
        <button class="rating-button" value="7">7</button>
        <button class="rating-button" value="8">8</button>
        <button class="rating-button" value="9">9</button>
        <button class="rating-button" value="10">10</button>
      </div>
      <p style="width: 100px;"> Very Funny </p>
    </div>
  </div>
  <div id="end_survey_quick_click" style="display: none;">
    <p>You have exceeded the number of clicks that were too quick(< 400 milliseconds). This is suspicious of random clicking or robot activity. We are sorry, but you can reload the page and start again and answer with deliberate clicks and human activity!</p>
  </div>
  <div id="thanks" style="display: none;">
    <p>Thank you for your time!</p>
  </div>

  <script>
    var imageUrls = [];
    var group = 0;
    var allImageUrls = [];
    var prolific_id = "";
    $.ajax({
      async: false,
      url: "https://ytgbbx4ihs4axjbynqgc6pbnou0cjzuc.lambda-url.us-east-1.on.aws/",
      type: "GET",
      success: function(data) {
        // Do something with the data
        group = data;
      },
      error: function(error) {
        // Handle the error
        console.log(error);
      }
    });
    $.ajax({
      async: false,
      url: "https://raw.githubusercontent.com/ethvedbitdesjan/MTurkProlificSurvey/master/Links/S3Files.txt",
      type: "GET",
      success: function(data) {
        // Do something with the data
        allImageUrls = data.split("\n");
      },
      error: function(error) {
        // Handle the error
        console.log(error);
      }
    });

    console.log(allImageUrls.length);
    var images_per_hit = 104;
    const num_groups = Math.floor(allImageUrls.length / images_per_hit);
    var start_idx = Math.min(group * images_per_hit, allImageUrls.length);
    var end_idx = Math.min((group + 1) * images_per_hit, allImageUrls.length);
    imageUrls = allImageUrls.slice(start_idx, end_idx);
    console.log(imageUrls.length);
    images_per_hit = 104;
    if (imageUrls.length < images_per_hit) {
      console.log("adding images");
      var num_extra = images_per_hit - imageUrls.length;
      for (let i = 0; i < num_extra; i++) {
        var random_idx = (Math.floor(Math.random() * (allImageUrls.length - imageUrls.length)));
        imageUrls.push(allImageUrls[random_idx]);
      }
    }

    var image_len = imageUrls.length;
    for (let i = 0; i < Math.floor(0.1 * image_len); i++) {
      var random_idx = (Math.floor(Math.random() * image_len));
      imageUrls.push(imageUrls[random_idx]);
    }
    console.log(group);
    console.log(imageUrls.length);
    //console.log(imageUrls);

    // async function getUrls() {
    //   let response = await fetch('https://raw.githubusercontent.com/ethvedbitdesjan/MTurkProlificSurvey/master/Links/GdriveLinks.txt');
    //   let data = await response.text();
    //   return data;
    // }
    // getUrls().then(data => {
    //   allImageUrls = data.split("\n");
    //   console.log(allImageUrls.length);
    // });
    

    var imageIndex = 0;
    var startTime = 0;
    var rating = 0;
    var ratings_list = [];
    var demographics = {};
    var image = document.getElementById('image');
    var ratingButtons = document.getElementsByClassName('rating-button');
    var img = new Image();
    var count_time = 0;
    var previous = [];

    img.onload = function() {
      image.src = this.src;
      var processing_message = document.getElementById('processing-message');
      processing_message.innerHTML = 'Continue';
      processing_message.style.display = 'block';
      startTime = new Date().getTime();
    };
    var processing_message = document.getElementById('processing-message');
    function displayImage() {
      processing_message.innerHTML = 'Processing...Please Wait and Do Not Click any Ratings Buttons';
      processing_message.style.display = 'block';
      img.src =  'https://vedaantfunnyimageshost.s3.amazonaws.com/' + imageUrls[imageIndex];
    }

    function ShowEndSurveyQuickClick() {
      var end_survey_quick_click = document.getElementById('end_survey_quick_click');
      end_survey_quick_click.style.display = 'block';
      var rating_container = document.getElementById('rating-container');
      rating_container.style.display = 'none';
      var image_container = document.getElementById('image-container');
      image_container.style.display = 'none';
    }

    function recordRating(buttonValue) {
      var endTime = new Date().getTime();
      var timeTaken = endTime - startTime;
      if (timeTaken < 400) {
        alert('Please spend more time looking at the image before rating it.');
        count_time++;
        if (count_time > 3) {
          ShowEndSurveyQuickClick();
        }
        return;
      }
      previous.push(buttonValue);
      if (previous.length > 6) {
        var all_same = true;
        for (let i = 0; i < previous.length - 1; i++) {
          if (previous[i] != previous[i + 1]) {
            all_same = false;
            break;
          }
        }
        if (all_same) {
          ShowEndSurveyQuickClick();
          return;
        }
        previous.shift();
      }
      rating = buttonValue;
      ratings_list.push([imageUrls[imageIndex], rating]);
      if (imageIndex < imageUrls.length - 1) {
        imageIndex++;
        displayImage();
      } else {
        // Submit the rating or perform any desired action
        console.log('Rating:', rating);
        var rating_container = document.getElementById('rating-container');
        if (rating_container.style.display === 'none') {
          rating_container.style.display = 'block';
        } else {
          rating_container.style.display = 'none';
        }
        var image_container = document.getElementById('image-container');
        if (image_container.style.display === 'none') {
          image_container.style.display = 'block';
        } else {
          image_container.style.display = 'none';
        }
        var thanks = document.getElementById('thanks');
        if (thanks.style.display === 'none') {
          thanks.style.display = 'block';
        } else {
          thanks.style.display = 'none';
        }
        var code = 'C1BIYWSA';
        thanks.getElementsByTagName('p')[0].innerHTML += ' Your code is ' + code;
        var url = 'https://5qdyuhwrhusr533dxdujc36qjm0odfvi.lambda-url.us-east-1.on.aws/';
        var data = {
          'code': prolific_id,
          'ratings': ratings_list,
          'demographics': demographics,
          'prolific' : 'true'
        };
        fetch(url, {'body':JSON.stringify(data), 'method':'POST', 'mode':'no-cors'})
        .then(function (response) {
          console.log('sent');
        })
        .catch(function (error) {
          console.log("Error: " + error);
        });
        return;
      }
    }

    // Add event listeners to rating buttons
    for (var i = 0; i < ratingButtons.length; i++) {
      ratingButtons[i].addEventListener('click', function() {
        var buttonValue = parseInt(this.value);
        recordRating(buttonValue);
      });
    }
    
    var start_button = document.getElementsByClassName('start-button')[0];
    start_button.addEventListener('click', function() {
      var welcome = document.getElementById('welcome');
      if (welcome.style.display === 'none') {
        welcome.style.display = 'block';
      } else {
        welcome.style.display = 'none';
      }
      console.log(welcome.style.display);
      var start_demogr = document.getElementById('start-demographic-info');
      if (start_demogr.style.display === 'none') {
        start_demogr.style.display = 'block';
      } else {
        start_demogr.style.display = 'none';
      }
      console.log(imageUrls.length);
    });

    var demogr_submit = document.getElementById('demogr-submit');
    demogr_submit.addEventListener('click', function() {
      var age = document.getElementsByName('age')[0].value;
      var gender = document.getElementsByName('gender')[0].value;
      var nationality = document.getElementsByName('nationality')[0].value;
      var education = document.getElementsByName('education')[0].value;
      var error_missing_message = document.getElementById('error-missing-message');
      var prolific_id_temp = document.getElementsByName('prolific-id')[0].value;
      if (gender === undefined || education === undefined || nationality === undefined || nationality === "" || prolific_id_temp === undefined || prolific_id_temp === "") {
        error_missing_message.style.display = 'block';
        console.log('error');
        return;
      }
      prolific_id = prolific_id_temp;
      var start_demogr = document.getElementById('start-demographic-info');
      start_demogr.style.display = 'none';
      error_missing_message.style.display = 'none';
      demographics['age'] = age;
      demographics['gender'] = gender;
      demographics['nationality'] = nationality;
      demographics['education'] = education;
      var rating_container = document.getElementById('rating-container');
      console.log(rating_container.style.display);
      if (rating_container.style.display === 'none') {
        rating_container.style.display = 'block';
        console.log(rating_container.style.display);
      } else {
        rating_container.style.display = 'none';
      }
      var image_container = document.getElementById('image-container');
      if (image_container.style.display === 'none') {
        image_container.style.display = 'block';
      } else {
        image_container.style.display = 'none';
      }
      console.log(imageUrls.length);
      displayImage();
      var processing_message = document.getElementById('processing-message');
      if (processing_message.style.display === 'none') {
        processing_message.style.display = 'block';
      } else {
        processing_message.style.display = 'none';
      }
    });
    // Set minimum question answering time (2 seconds)
    setTimeout(function() {
      if (rating === 0) {
        // Do something if the user hasn't provided a rating
      }
    }, 2000);

    // Initial image display
    //displayImage();
  </script>
</body>
</html>
